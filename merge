#!/bin/bash
# merge: stage, commit, push to a feature branch, and open a PR for derekzacharias/sprink
set -euo pipefail

usage() {
  cat <<'EOF'
Usage: merge [options]

Options:
  -m, --message <msg>    Commit message (default: "Automated commit on <timestamp>")
  -b, --branch <name>    Feature branch name (default: auto/<timestamp> if on base, else current branch)
  -B, --base <name>      Base branch for the PR (default: origin default or "main")
  -t, --title <title>    Pull request title (default: commit message)
  -d, --body <body>      Pull request body text (default: auto summary)
  -R, --repo <url>       Remote URL to use for origin (default: git@github.com:derekzacharias/sprink.git)
      --https            Use HTTPS default instead of SSH
      --no-pr            Do not create a pull request
      --sign             Use -S to sign the commit if configured
  -h, --help             Show this help message
EOF
}

commit_msg=""
feature_branch=""
base_branch=""
pr_title=""
pr_body=""
repo_url_default="git@github.com:derekzacharias/sprink.git"
https_default="false"
no_pr="false"
sign_flag=""

# Parse args
while [[ $# -gt 0 ]]; do
  case "$1" in
    -m|--message) commit_msg="${2:-}"; shift 2 ;;
    -b|--branch)  feature_branch="${2:-}"; shift 2 ;;
    -B|--base)    base_branch="${2:-}"; shift 2 ;;
    -t|--title)   pr_title="${2:-}"; shift 2 ;;
    -d|--body)    pr_body="${2:-}"; shift 2 ;;
    -R|--repo)    repo_url_default="${2:-}"; shift 2 ;;
    --https)      https_default="true"; shift 1 ;;
    --no-pr)      no_pr="true"; shift 1 ;;
    --sign)       sign_flag="-S"; shift 1 ;;
    -h|--help)    usage; exit 0 ;;
    *) echo "Unknown option: $1" >&2; usage; exit 1 ;;
  esac
done

# Ensure in a git repo
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: Not inside a Git repository." >&2
  exit 1
fi

# Determine base branch from origin/HEAD
if [[ -z "$base_branch" ]]; then
  origin_head="$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null || true)"
  if [[ -n "$origin_head" ]]; then
    base_branch="${origin_head##*/}"
  else
    base_branch="main"
  fi
fi

# Ensure origin exists and points to sprink by default
if ! git remote get-url origin >/dev/null 2>&1; then
  echo "Adding origin remote."
  if [[ "$https_default" == "true" ]]; then
    git remote add origin "https://github.com/derekzacharias/sprink.git"
  else
    git remote add origin "$repo_url_default"
  fi
fi

# Normalize remote if it does not point to the desired repo and user didn't override
current_origin="$(git remote get-url origin)"
desired_default="$repo_url_default"
if [[ "$https_default" == "true" && "$repo_url_default" == "git@github.com:derekzacharias/sprink.git" ]]; then
  desired_default="https://github.com/derekzacharias/sprink.git"
fi

case "$current_origin" in
  *derekzacharias/sprink.git*|*derekzacharias/sprink)
    : # ok
    ;;
  *)
    echo "Updating origin to $desired_default"
    git remote set-url origin "$desired_default"
    ;;
esac

# Get latest refs for base
git fetch origin --prune >/dev/null 2>&1 || true
git fetch origin "$base_branch" >/dev/null 2>&1 || true

current_branch="$(git rev-parse --abbrev-ref HEAD)"

# Choose feature branch
if [[ -z "$feature_branch" ]]; then
  if [[ "$current_branch" == "$base_branch" ]]; then
    ts="$(date +%Y%m%d-%H%M%S)"
    feature_branch="auto/$ts"
    echo "Creating feature branch $feature_branch from origin/$base_branch"
    if git switch -c "$feature_branch" "origin/$base_branch" >/dev/null 2>&1; then :; else git checkout -b "$feature_branch" "origin/$base_branch"; fi
  else
    feature_branch="$current_branch"
  fi
else
  # Switch or create specified feature branch
  if git rev-parse --verify "$feature_branch" >/dev/null 2>&1; then
    git switch "$feature_branch" >/dev/null 2>&1 || git checkout "$feature_branch"
  else
    if git switch -c "$feature_branch" "origin/$base_branch" >/dev/null 2>&1; then :; else git checkout -b "$feature_branch" "origin/$base_branch"; fi
  fi
fi

# Stage changes
git add -A

if git diff --cached --quiet; then
  echo "No staged changes detected. Aborting."
  exit 0
fi

# Commit
if [[ -z "$commit_msg" ]]; then
  commit_msg="Automated commit on $(date +%Y-%m-%d' '%H:%M:%S)"
fi
git commit $sign_flag -m "$commit_msg"

# Push
git push -u origin "$feature_branch"

# Prepare PR metadata
[[ -z "$pr_title" ]] && pr_title="$commit_msg"
if [[ -z "$pr_body" ]]; then
  pr_body=$(cat <<EOF
## Summary
- $commit_msg

Auto generated by merge helper.
EOF
)
fi

# Create PR unless suppressed
if [[ "$no_pr" != "true" ]]; then
  if command -v gh >/dev/null 2>&1; then
    echo "Creating pull request via GitHub CLI..."
    if gh pr view "$feature_branch" >/dev/null 2>&1; then
      echo "PR already exists for $feature_branch"
    else
      gh pr create --base "$base_branch" --head "$feature_branch" --title "$pr_title" --body "$pr_body"
      echo "Pull request created."
    fi
  else
    echo "GitHub CLI not found. Skipping PR creation."
    echo "Create a PR from $feature_branch into $base_branch in GitHub."
  fi
else
  echo "PR creation skipped per --no-pr."
fi

echo "Done. Branch $feature_branch pushed to origin. Base $base_branch"

